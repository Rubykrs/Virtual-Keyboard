const keyboardArray = [
  [
    {
      className: 'usualBottomBlack',
      value: "§",
      subValue: "±",
      valueRu: ">",
      subValueRu: "<",
    },
    {
      className: 'usualBottom',
      value: 1,
      valueRu: 1,
      subValue: "!"
    },
    {
      className: 'usualBottom',
      value: 2,
      valueRu: 2,
      subValue: "@",
      subValueRu: '"',
    },
    {
      className: 'usualBottom',
      value: 3,
      valueRu: 3,
      subValue: "#",
      subValueRu: "№",
    },
    {
      className: 'usualBottom',
      value: 4,
      valueRu: 4,
      subValue: "$",
      subValueRu: "%",
    },
    {
      className: 'usualBottom',
      value: 5,
      valueRu: 5,
      subValue: "%",
      subValueRu: ":",
    },
    {
      className: 'usualBottom',
      value: 6,
      valueRu: 6,
      subValue: "^",
      subValueRu: ",",
    },
    {
      className: 'usualBottom',
      value: 7,
      valueRu: 7,
      subValue: "&",
      subValueRu: ".",
    },
    {
      className: 'usualBottom',
      value: 8,
      valueRu: 8,
      subValue: "*",
      subValueRu: ";",
    },
    {
      className: 'usualBottom',
      value: 9,
      valueRu: 9,
      subValue: "(",
    },
    {
      className: 'usualBottom',
      value: 0,
      valueRu: 0,
      subValue: ")",
    },
    {
      className: 'usualBottom',
      value: "-",
      valueRu: "-",
      subValue: "_",
    },
    {
      className: 'usualBottom',
      value: "=",
      valueRu: "=",
      subValue: "+",
    },
    {
      className: 'bigBlackBottom',
      value: "Backspace",
    }
  ],
  [
    {
      className: 'tabBottom',
      value: "Tab",
    },
    {
      className: 'usualBottom',
      value: "Q",
      valueRu: "Й",
    },
    {
      className: 'usualBottom',
      value: "W",
      valueRu: "Ц",
    },
    {
      className: 'usualBottom',
      value: "E",
      valueRu: "У",
    },
    {
      className: 'usualBottom',
      value: "R",
      valueRu: "К",
    },
    {
      className: 'usualBottom',
      value: "T",
      valueRu: "Е",
    },
    {
      className: 'usualBottom',
      value: "Y",
      valueRu: "Н",
    },
    {
      className: 'usualBottom',
      value: "U",
      valueRu: "Г",
    },
    {
      className: 'usualBottom',
      value: "I",
      valueRu: "Ш",
    },
    {
      className: 'usualBottom',
      value: "O",
      valueRu: "Щ",
    },
    {
      className: 'usualBottom',
      value: "P",
      valueRu: "З",
    },
    {
      className: 'usualBottom',
      value: "[",
      subValue: "{",
      valueRu: "Х",
    },
    {
      className: 'usualBottom',
      value: "]",
      subValue: "}",
      valueRu: "Ъ",
    },
  ],
  [
    {
      className: 'bigBlackBottom',
      value: "Caps Lock",
    },
    {
      className: 'usualBottom',
      value: "A",
      valueRu: "Ф",
    },
    {
      className: 'usualBottom',
      value: "S",
      valueRu: "Ы",
    },
    {
      className: 'usualBottom',
      value: "D",
      valueRu: "В",
    },
    {
      className: 'usualBottom',
      value: "F",
      valueRu: "А",
    },
    {
      className: 'usualBottom',
      value: "G",
      valueRu: "П",
    },
    {
      className: 'usualBottom',
      value: "H",
      valueRu: "Р",
    },
    {
      className: 'usualBottom',
      value: "J",
      valueRu: "О",
    },
    {
      className: 'usualBottom',
      value: "K",
      valueRu: "Л",
    },
    {
      className: 'usualBottom',
      value: "L",
      valueRu: "Д",
    },
    {
      className: 'usualBottom',
      value: ";",
      subValue: ":",
      valueRu: "Ж",
    },
    {
      className: 'usualBottom',
      value: "'",
      subValue: '"',
      valueRu: "Э",
    },
    {
      className: 'usualBottom',
      value: "",
      subValue: "|",
      valueRu: "Ё",
    },
    {
      className: 'doublUsualBottom',
      value: "Enter",
    },
  ],
  [
    {
      className: 'bigBlackBottom',
      value: "Shift",
    },
    {
      className: 'usualBottom',
      value: "`",
      valueRu: "]",
      subValue: "~",
      subValueRu: "[",
    },
    {
      className: 'usualBottom',
      value: "Z",
      valueRu: "Я",
    },
    {
      className: 'usualBottom',
      value: "X",
      valueRu: "Ч",
    },
    {
      className: 'usualBottom',
      value: "C",
      valueRu: "C",
    },
    {
      className: 'usualBottom',
      value: "V",
      valueRu: "М",
    },
    {
      className: 'usualBottom',
      value: "B",
      valueRu: "И",
    },
    {
      className: 'usualBottom',
      value: "N",
      valueRu: "Т",
    },
    {
      className: 'usualBottom',
      value: "M",
      valueRu: "Ь",
    },
    {
      className: 'usualBottom',
      value: ",",
      subValue: "<",
      valueRu: "Б",
    },
    {
      className: 'usualBottom',
      value: ".",
      subValue: ">",
      valueRu: "Ю",
    },
    {
      className: 'usualBottom',
      value: "/",
      subValue: "?"
    },
    {
      className: 'miniBottom',
      value: "up",
    },
    {
      className: 'doublUsualBottom',
      value: "Shift",
    },
  ],
  [
    {
      className: 'usualBottom',
      value: "fn",
    },
    {
      className: 'usualBottom',
      value: "ctrl",
    },
    {
      className: 'usualBottom',
      value: "alt",
    },
    {
      className: 'averegeBottom',
      value: "cmd",
    },
    {
      className: 'hugeBottom',
      value: "Escape",
    },
    {
      className: 'averegeBottom',
      value: "cmd",
    },
    {
      className: 'usualBottom',
      value: "alt",
    },
    {
      className: 'usualBottom',
      value: "alt",
    },
    {
      className: 'miniBottom',
      value: "left",
    },
    {
      className: 'miniBottom',
      value: "down",
    },
    {
      className: 'miniBottom',
      value: "right",
    },
  ]
];

let curentLeng = 'EN';
let selectionStart = null;
let selectionEnd = null;



const head = document.querySelector("head");
const body = document.querySelector("body");
const link = document.createElement("link");

const container = document.createElement("div");
container.className = "container";

const containerKeyboard = document.createElement("div");
containerKeyboard.className = "containerKeyboard";

const input = document.createElement("textarea");
input.className = "input";

input.onselect = function() {
  selectionStart = input.selectionStart
  selectionEnd = input.selectionEnd
}

input.oninput = function() {
  selectionStart = input.selectionStart
  selectionEnd = input.selectionEnd
}

input.onclick = function() {
  selectionStart = input.selectionStart
  selectionEnd = input.selectionEnd
}

input.onfocus = function() {
  selectionStart = input.selectionStart
  selectionEnd = input.selectionEnd
}

for (let i = 0; i < keyboardArray.length; i++){
  const currentKeyboardRow = document.createElement("div");
  currentKeyboardRow.className = "keyboardArrayRow";
  // заполняем строчку 
  for (let j = 0; j < keyboardArray[i].length; j++) {
    const button = document.createElement("div");
    const subBottom = document.createElement("div");
    const subBottomRu = document.createElement("div");
    button.className = keyboardArray[i][j].className;
    subBottom.className = "subBottom";
    subBottomRu.className = "subBottom";
    subBottom.innerHTML = keyboardArray[i][j].value;
    if (keyboardArray[i][j].subValue) {
      subBottomRu.innerHTML = keyboardArray[i][j].subValue;
    }
    // помещаем кнопку в строчку
    button.appendChild(subBottom);
    button.appendChild(subBottomRu);
    button.addEventListener("click", () => {
      if (curentLeng === "EN") {
        if(keyboardArray[i][j].value === "Backspace") {
          let initSelectionStart = selectionStart + -1;
            if(selectionEnd === selectionStart) {
              selectionStart = selectionStart - 1;
            }
            let inputStr = input.value.split('');
            while (selectionStart < selectionEnd) {
              inputStr[selectionStart] = null;
              selectionStart++;
            }
            inputStr = inputStr.join('');
            input.value = inputStr;
            input.focus();
            input.selectionStart = initSelectionStart;
            input.selectionEnd = initSelectionStart;
        } else if (keyboardArray[i][j].value === "Enter") {
          input.value += '\n';
          input.focus();
        } else if (keyboardArray[i][j].value === "Escape") {
          input.value += ' ';
          input.focus();
        } else {
          input.value += keyboardArray[i][j].value
        }
      } else {
        if(keyboardArray[i][j].value === "Backspace") {
          let initSelectionStart = selectionStart + -1;
            if(selectionEnd === selectionStart) {
              selectionStart = selectionStart - 1;
            }
            let inputStr = input.value.split('');
            while (selectionStart < selectionEnd) {
              inputStr[selectionStart] = null;
              selectionStart++;
            }
            inputStr = inputStr.join('');
            input.value = inputStr;
            input.focus();
            input.selectionStart = initSelectionStart;
            input.selectionEnd = initSelectionStart;
        } else if (keyboardArray[i][j].value === "Enter") {
          input.value += '\n';
          input.focus();
        } else if (keyboardArray[i][j].value === "Escape") {
          input.value += ' ';
          input.focus();
        } else {
          input.value += keyboardArray[i][j].valueRu
        }
      }
    })
    currentKeyboardRow.appendChild(button);
  }
  // помещаем строчку в клавиатурк 
  containerKeyboard.appendChild(currentKeyboardRow);
}


// for (let i = 0; i < keyboardArrayRow1.length; i++) {
//   const buttom = document.createElement("div");
//   buttom.className = keyboardArrayRow1[i].className;
//   keyboardRow1.appendChild(buttom);
// }

link.setAttribute("rel", "stylesheet");
link.setAttribute("href", "/style.css");
head.appendChild(link);

container.appendChild(input);
container.appendChild(containerKeyboard);
body.appendChild(container);


function runOnKeys(func, ...codes) {
  let pressed = new Set();

  document.addEventListener('keydown', function(event) {
    pressed.add(event.code);

    for (let code of codes) {
      if (!pressed.has(code)) {
        return;
      }
    }
    pressed.clear();

    func();
  });
  document.addEventListener('keyup', function(event) {
    pressed.delete(event.code);
  });

}

runOnKeys(
  () => {

    if (curentLeng === "EN") {
      const keyboardArrayRowArray = document.querySelectorAll(".keyboardArrayRow");
      for (let i = 0; i < keyboardArray.length; i++) {
        const currentKeyboardRow = keyboardArrayRowArray[i].childNodes;
        for (let j = 0; j < currentKeyboardRow.length; j++) {
          let curentButton = currentKeyboardRow[j].childNodes[0];
          let curentButtonSub = currentKeyboardRow[j].childNodes[1];
          if (keyboardArray[i][j].valueRu) {
            curentButton.innerHTML = keyboardArray[i][j].valueRu;
          }
          if (keyboardArray[i][j].subValueRu) {
            curentButtonSub.innerHTML = keyboardArray[i][j].subValueRu;
          }
        }
      }
      curentLeng = "RU";
    } else {
      const keyboardArrayRowArray = document.querySelectorAll(".keyboardArrayRow");
      for (let i = 0; i < keyboardArray.length; i++) {
        const currentKeyboardRow = keyboardArrayRowArray[i].childNodes;
        for (let j = 0; j < currentKeyboardRow.length; j++) {
          let curentButton = currentKeyboardRow[j].childNodes[0];
          let curentButtonSub = currentKeyboardRow[j].childNodes[1];
          if (keyboardArray[i][j].value) {
            curentButton.innerHTML = keyboardArray[i][j].value;
          }
          if (keyboardArray[i][j].subValueRu) {
            curentButtonSub.innerHTML = keyboardArray[i][j].subValue;
          }
        }
      }
      curentLeng = "EN";
    }
  },
  "ControlLeft",
  "Space"
);